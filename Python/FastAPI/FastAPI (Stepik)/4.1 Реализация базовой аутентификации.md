**Аутентификация** и **авторизация** являются **важнейшими** аспектами создания защищенных веб-приложений. Аутентификация гарантирует, что пользователи являются теми, за кого себя выдают, в то время как авторизация контролирует, к каким действиям и ресурсам они могут получить доступ.


## Что такое аутентификация?
**Аутентификация** и **авторизация** являются **важнейшими** аспектами создания защищенных веб-приложений. Аутентификация гарантирует, что пользователи являются теми, за кого себя выдают, в то время как авторизация контролирует, к каким действиям и ресурсам они могут получить доступ

## Как работает базовая аутентификация?

**Базовая аутентификация** - это простой метод, при котором клиент _(обычно веб-браузер или клиент API)_ вводит имя пользователя и пароль в заголовок запроса `` `Authorization` ``. Затем сервер проверяет эти учетные данные в базе данных пользователя или у поставщика аутентификации. FastAPI обеспечивает **встроенную** поддержку базовой аутентификации, что упрощает ее реализацию.

##  Реализация базовой аутентификации
```python
#models.py

from pydantic import BaseModel


class User(BaseModel):
	username: str
	password: str

# Имитация пользователей в базе данных 

USER_DATA = [User(**{'username': 'user1', 'password': 'pass1'}), User(**{'username': 'user2', 'password': 'pass2'})]
```


```python
# main.py
from fastapi import FastAPI, Depends, status, HTTPException
from fastapi.security import HTTPBasic, HTTPBasicCredentials
from models import User, USER_DATA

# credentials - учетные данные проверки подлинности, используемые для доступа к ресурсу
app = FastAPI()
security = HTTPBasic() 


# Симуляционный пример
def get_user_from_db(username: str):
	for user in USER_DATA:
		if user.username == username:
			return user
	return None

def auth_user(credentials: HttpBasicCredentials = Depends(security)):
	user = get_user_from_db(credentials.username)
	if user is None or user.password != credentials.password:
		raise HttpException(
			status_code=status.HTTP_401_UNAUTHORIZED, 
			detail='Invalid credentials'
		)
	return user


@app.get("/protected_resource/")
def get_protected_resource(user: User = Depends(auth_user)):
	return {
		"message": "You have access to the protected resource!",
		"user_info": user
	}
```


* **Depends** - используется для объявления зависимостей в вашем маршруте. Это может быть полезно для внедрения зависимостей, таких как службы или функции, которые выполняют общие задачи, такие как проверка аутентификации или доступа к базе данных.

* **status -** содержит предопределённые HTTP-статусы, такие как `HTTP_200_OK`, `HTTP_404_NOT_FOUND` и т.д. Это помогает сделать код более читаемым и понятным.
* **HTTPException -** используется для генерации HTTP исключений с указанным статус-кодом и сообщением
* **HTPPBasic -** используется для реализации базовой HTTP-аутентификации. Это простой метод аутентификации, который использует заголовок Authorization с именем пользователя и паролем.
* **HTTPBasicCredentials -** используется для работы с учетными данными, переданными в базовой HTTP-аутентификации. Он имеет два атрибута: `username` и `password`.

## Немного о внедрении зависимостей

**Внедрение зависимостей (dependency injection) в FastAP**I — это способ управления тем, как компоненты приложения получают доступ к своим зависимостям, например, к базам данных, внешним сервисам, конфигурациям и другим ресурсам. Вот основные идеи и как это работает в FastAPI:

1. **Что такое зависимости?** Зависимость — это любой объект, который нужен вашему коду для выполнения работы. Например, если функция обрабатывает HTTP-запрос и ей нужно получить данные из базы данных, то соединение с базой данных будет зависимостью.
    
2. **Зачем нужно внедрение зависимостей?** Внедрение зависимостей помогает:
    
    - Упростить тестирование, заменяя реальные зависимости моками или фиктивными объектами.
    - Улучшить читаемость и поддержку кода, явно указывая зависимости.
    - Повторно использовать код, избегая дублирования.
3. **Как работает внедрение зависимостей в FastAPI?** В FastAPI используется специальный декоратор `Depends`, который помогает управлять зависимостями. Вот пример:
    ```python
    from fastapi import FastAPI, Depends


	app = FastAPI()

	def get_db():
	    db = DatabaseConnection()
	    try:
	        yield db
	    finally:
	        db.close()


	@app.get("/items/")
	def read_items(db = Depends(get_db)):
	    items = db.query("SELECT * FROM items")
	    return items

```
    
    В этом примере:
    
    - Функция `get_db` создает соединение с базой данных и возвращает его с помощью ключевого слова `yield`.
    - `Depends(get_db)` указывает FastAPI, что функция `read_items` зависит от функции `get_db`.
    - Когда `read_items` вызывается, FastAPI автоматически вызывает `get_db`, получает соединение с базой данных и передает его в `read_items` как аргумент `db`.
    - 
	**Преимущества использования `Depends`:**
    
    - **Автоматическое управление жизненным циклом зависимостей**: FastAPI сам решает, когда создавать и закрывать зависимости.
    - **Явное указание зависимостей**: Код становится более прозрачным, так как зависимости явно указаны в сигнатурах функций.
    - **Гибкость**: Вы можете легко менять реализации зависимостей, что упрощает тестирование и поддержку.

В итоге, внедрение зависимостей в FastAPI помогает сделать ваш код более структурированным, тестируемым и поддерживаемым.


## Безопасность
 Базовая аутентификация проста в реализации, но она имеет _некоторые ограничения безопасности_, такие как передача учетных данных **в виде обычного текста**. Для более безопасных механизмов аутентификации вы можете изучить аутентификацию **на основе JWT** или интегрировать сторонние поставщики аутентификации, **такие как OAuth**.

* **Про JWT токены -** https://habr.com/ru/articles/340146/
* **Про OAuth -** https://habr.com/ru/companies/vk/articles/115163/