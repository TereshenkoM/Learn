
## Важность обработки ошибок

Обработка ошибок является важнейшим аспектом создания надежных веб-приложений. Это включает в себя **предвидение** потенциальных ошибок или исключений, которые могут возникнуть во время выполнения приложения, и корректную обработку их. В этом уроке мы сосредоточимся на пользовательской _(кастомной)_ обработке ошибок в FastAPI, чтобы обеспечить информативные и удобные для пользователя ответы на ошибки.


## Ответы на ошибки по умолчанию в FastAPI

FastAPI **автоматически** генерирует ответы об ошибках для распространенных кодов состояния HTTP, таких как 404 (Not found) или 500 (internal server error). Хотя эти ответы по умолчанию полезны, пользовательская обработка ошибок позволяет нам адаптировать ответы на ошибки в соответствии с требованиями нашего приложения.

## Создание пользовательских исключений
```python
from fastapi import FastAPI, HttpException


app = FastAPI()

class CustomException(HttpException):
	def __init__(self, detail: str, status_code: int = 400):
		super().__init__(status_code=status_code, detail=detail)


@app.get('/')
async def root(item_id: int):
	if item_id == 42:
		raise CustomException(detail='123', status_code=404)
	return {'item_id': item_id}
```

В приведенном выше примере мы создали пользовательский класс исключений `` `CustomException` ``, который наследуется от `` `HttpException` ``. Класс `` `CustomException` `` принимает два параметра: `` `detail` `` (сообщение об ошибке) и `` `status_code` `` (код состояния HTTP). Мы вызываем метод `` `__init__` `` родительского класса `` `HttpException` `` с предоставленными аргументами `` `detail` `` и `` `status_code` ``.

В маршруте `` `read_item` `` мы проверяем, равен ли `` `item_id` `` 42. Если это так, мы создаем наше пользовательское исключение с сообщением об ошибке "Элемент не найден" и кодом состояния 404 (Not found). В противном случае мы возвращаем словарь с `` `item_id` ``.

Использование пользовательских классов исключений, подобных этому, позволяет вам создавать более значимые и конкретные ответы на ошибки для вашего API. Вы можете адаптировать сообщения об ошибках и коды состояния в соответствии с требованиями вашего приложения и предоставлять клиентам четкую информацию при возникновении ошибки.

## Регистрация пользовательских обработчиков исключений

После создания пользовательских классов исключений мы можем зарегистрировать **обработчики исключений** для захвата и обработки определенных типов исключений. FastAPI предоставляет декоратор `` `@app.exception_handler` `` для связывания классов исключений с их соответствующими обработчиками.

Давайте расширим предыдущий код для регистрации Error handler'а (обработчика исключений):

```python
from fastapi import FastAPI, HTTPException, Request
from fastapi.responses import JSONResponse

app = FastAPI()


# не изменяли
class CustomException(HTTPException):
    def __init__(self, detail: str, status_code: int = 400):
        super().__init__(status_code=status_code, detail=detail)


# Обработчик ошибок (error handler) для класса CustomException 
@app.exception_handler(CustomException)
async def custom_exception_handler(request: Request, exc: CustomException):
    return JSONResponse(
        status_code=exc.status_code,
        content={"error": exc.detail}
    )


# не изменяли
@app.get("/items/{item_id}/")
async def read_item(item_id: int):
    if item_id == 42:
        raise CustomException(detail="Item not found", status_code=404)
    return {"item_id": item_id}
```

В обновленном коде мы добавили пользовательский обработчик ошибок с именем `` `custom_exception_handler` `` для класса `` `CustomException` ``, используя декоратор `` `app.exception_handler()` ``. Эта функция принимает два параметра: `` `request` `` (текущий объект запроса) и `` `exc` `` (экземпляр вызванного исключения).

Функция `` `custom_exception_handler` `` возвращает `` `JsonResponse` `` с соответствующим кодом состояния HTTP и телом JSON, содержащим поле `` `error` `` с сообщением `` `detail` `` пользовательского исключения.

Теперь всякий раз, когда в приложении возникает `` `CustomException` `` (как мы делаем в маршруте `` `/items/{item_id}/` ``), будет вызван пользовательский обработчик ошибок, и пользовательский ответ об ошибке будет возвращен клиенту.

Такой подход позволяет вам обрабатывать конкретные исключения с помощью настраиваемых ответов, обеспечивая лучший контроль и согласованность при обработке ошибок во всем вашем приложении FastAPI.