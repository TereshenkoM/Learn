Добавим в директорию tests файл conftest.py:

```
project/  
├── src/  
│   ├── __init__.py            
│   └── main.py         # Исходный код 
├── tests/              # Тесты  
│   ├── __init__.py     # Пустой файл (чтобы pytest видел tests как модуль)  
│   ├── conftest.py     # Специальный файл для хранения фикстур
│   └── test_main.py    # Тесты для main.py
├── test_venv/
└── pytest.ini          # Конфигурационный файл pytest  
```

**`conftest.py`** — это специальный файл в pytest, который используется для хранения **фикстур**(fixtures) и других настроек тестов.

**Фикстуры** — это вспомогательные функции, которые подготавливают данные, настраивают окружение или создают зависимости для тестов.  
 

**Зачем нужен `conftest.py`?**

1.  **Упрощение тестов**    
    - Фикстуры из `conftest.py` автоматически доступны во всех тестах **без явного импорта**.
    - Тесты становятся чище и короче.
    
2.  **Переиспользование кода**
    - Общие настройки (например, подключение к БД, создание тестовых данных) можно вынести в `conftest.py` и использовать в разных тестах.
    
3.  **Гибкость**
    - Можно переопределять фикстуры для конкретных тестов или папок.
    - Поддерживает **область видимости** (`scope="session"`, `scope="module"`, `scope="function"`).


Разберем на примере и начнем упрощать тест `test_create_receipt`

Содержимое `confest.py`
```python
import pytest  
from fastapi.testclient import TestClient  
from src.main import app  
  
@pytest.fixture  
def test_client():  # <- вынесли тестовый клиент в фикстуры  
    yield TestClient(app)
```

Содержимое `test_main.py`
```python
from fastapi.testclient import  TestClient  
from fastapi import status  
from sqlalchemy import create_engine  
from sqlalchemy.orm import Session  
  
from src.main import app, get_session, Base  
  
  
def test_create_receipt(test_client: TestClient):  
    #arrange  
    engine = create_engine(  
        "sqlite:///testing.db:",  
        connect_args={  
            "check_same_thread": False,  
        })  
    Base.metadata.create_all(engine) # Создали тестовую БД  
  
    with Session(engine) as session:  
        def get_session_override():  
            return session  
  
        app.dependency_overrides[get_session] = get_session_override  # <- перезаписываем зависимости  
        # убираем определение test_client в самом тесте  
    data = {  
        "total": 10000,  
        "vat": 2000,  
        "client_phone": "+79111111111",  
        "cashier_inn": "7357735773577357"  
    }  
  
    # act  
    response = test_client.post("/receipts/", json = data)  
    app.dependency_overrides.clear()  # <- возвращаем зависимости к исходному состоянию  
    data = response.json()  
  
    # assert  
    assert response.status_code == status.HTTP_201_CREATED  
    assert data["id"] is not None
```

Далее вынесем определение БД в фикстуры, так как этот код будет использоваться не только в одном месте
```python
import pytest  
from fastapi.testclient import TestClient  
from src.main import app, get_session  
from sqlalchemy import create_engine  
from src.main import Base  
from sqlalchemy.orm import Session  
  
  
@pytest.fixture()  
def test_engine():  
    engine = create_engine(  
        "sqlite:///testing.db:",  
        connect_args={  
            "check_same_thread": False,  
        })  
    Base.metadata.create_all(engine)  
    yield engine  
    Base.metadata.drop_all(engine)  
  
  
@pytest.fixture  
def test_session(test_engine):  
    with Session(test_engine) as session:  
        yield session  
  
  
@pytest.fixture  
def test_client(test_session):  # <- вынесли тестовый клиент в фикстуры  
    app.dependency_overrides[get_session] = lambda: test_session  
    yield TestClient(app)  
    app.dependency_overrides.clear()
```

Допишем тест на получение данных
```python
from fastapi import status  
from sqlalchemy.orm import Session  
from fastapi.testclient import TestClient  
  
from src.main import Receipt  
  
  
def test_create_receipt(test_client):  
    data = {  
        "total": 10000,  
        "vat": 2000,  
        "client_phone": "+79111111111",  
        "cashier_inn": "7357735773577357",  
    }  
  
    response = test_client.post("/receipts/", json = data)  
    data = response.json()  
  
    assert response.status_code == status.HTTP_201_CREATED  
    assert data["id"] is not None  
  
  
def test_read_receipts(test_session: Session, test_client: TestClient):  
    receipt_1 = Receipt(total=10000,  vat=2000, client_phone="+79111111111", cashier_inn='7357735773577357')  
    receipt_2 = Receipt(total=5000, vat=100, client_phone="+7953535353", cashier_inn='1111111111111111')  
  
    test_session.add(receipt_1)  
    test_session.add(receipt_2)  
  
    test_session.commit()  
  
    response = test_client.get("/receipts/")  
    data = response.json()  
  
    assert response.status_code == status.HTTP_200_OK  
  
    assert len(data) == 2  
    for receipt, observed in zip([receipt_1, receipt_2], data):  
        assert observed['id'] == receipt.id  
        assert observed['total'] == receipt.total
```

![[Pasted image 20251020210712.png]]

Для запуска **конкретного теста или группы тестов в pytest** можно воспользоваться флагов -k.

```
pytest -k "test_read_receipts" # Запустит только этот тест
pytest -k "TestReceipts"       # Запустит все тесты внутри класса TestReceipts
pytest -k "read"               # Запустит все тесты, где есть 'read' в названии
```


**Области видимости**
В pytest фикстуры могут иметь разную **область видимости (scope)**, которая определяет, как часто они будут создаваться и переиспользоваться во время выполнения тестов.

1. **`function`** (по умолчанию) — новая фикстура для **каждого теста**.
2. **`class`** — одна фикстура на **весь класс** тестов.
3. **`module`** — одна фикстура на **модуль** (файл с тестами).
4. **`package`** — одна фикстура на **пакет** (директорию с тестами).
5. **`session`** — одна фикстура на **все тесты** в запуске.

В директории tests создадим файл **test_scope.py**
```
project/  
├── src/  
│   ├── __init__.py            
│   └── main.py         # Исходный код 
├── tests/              # Тесты  
│   ├── __init__.py     # Пустой файл (чтобы pytest видел tests как модуль)  
│   ├── conftest.py     # Специальный файл для хранения фикстур
│   ├── test_scope.py   # Тесты для понимания области видимости фикстур
│   └── test_main.py    # Тесты для main.py
├── test_venv/
└── pytest.ini          # Конфигурационный файл pytest
```

**Содержимое test_scope.py::**
```python
import pytest


@pytest.fixture(scope="session")
def order():
    return []


@pytest.fixture
def func(order):
    order.append("function")


@pytest.fixture(scope="class")
def cls(order):
    order.append("class")


@pytest.fixture(scope="module")
def mod(order):
    order.append("module")


@pytest.fixture(scope="package")
def pack(order):
    order.append("package")


@pytest.fixture(scope="session")
def sess(order):
    order.append("session")


class TestClass:
    def test_order(self, func, cls, mod, pack, sess, order):
        assert order == ["session", "package", "module", "class", "function"]
```

![[Pasted image 20251020211133.png]]

Как это работает:

1. **Фикстура `order`** (с `scope="session"`) создаётся **первой** и живёт до конца всех тестов.
2. Остальные фикстуры (`sess`, `pack`, `mod`, `cls`, `func`) добавляют значения в `order` **в порядке своего scope:** от самого широкого (`session`) до самого узкого (`function`).    
3. В итоге `assert` проверяет, что порядок вызовов правильный: `assert order == ["session", "package", "module", "class", "function"]`


> Важно запомнить порядок применения скоупов!  
> `session` → `package` → `module` → `class` → `function` 

**Шпаргалка по скоупом фикстур:** 

| Scope      | Когда использовать?                    | Примеры применения          |
| ---------- | -------------------------------------- | --------------------------- |
| `session`  | Дорогие ресурсы (БД, API-клиенты)      | `db_connection`, `config`   |
| `module`   | Общие данные для всех тестов в файле   | `test_data`, `mock_service` |
| `class`    | Общие зависимости для методов класса   | `api_client`, `auth_header` |
| `function` | Изолированные данные для каждого теста | `clean_db`, `temp_file`     |