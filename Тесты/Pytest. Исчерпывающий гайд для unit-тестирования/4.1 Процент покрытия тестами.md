**Что такое pytest-cov?**

`pytest-cov` - это плагин для pytest, который позволяет измерять покрытие кода тестами (code coverage). Он интегрируется с инструментом coverage.py и предоставляет удобный способ проверки, какая часть вашего кода выполняется тестами.

**Установка**

```cmake
pip install pytest-cov
```

**Базовое использование**

Запуск с измерением покрытия  
`pytest --cov=src`

![[Pasted image 20251020212358.png]]

Однако легче расширить `pytest.ini`, чтобы просто вызывать команду `pytest`:  
**Cодержимое pytest.ini:**
```
[pytest]  
;Где искать тесты  
testpaths = tests  
;Шаблон для поиска тестов  
python_files = "test_*.py"  
; Дополнительные опции (-v — подробный вывод)  
addopts = -v --cov=src
```

Также pytest-cov можно дополнительно настроить
```
project/  
├── src/  
│   ├── __init__.py            
│   └── main.py         # Исходный код 
├── tests/              # Тесты  
│   ├── __init__.py     # Пустой файл (чтобы pytest видел tests как модуль)  
│   ├── conftest.py     # Специальный файл для хранения фикстур
│   ├── test_scope.py   # Тесты для понимания области видимости фикстур
│   └── test_main.py    # Тесты для main.py
├── test_venv/
├── .coveragerc         # Конфигурационный файл pytest-cov
└── pytest.ini          # Конфигурационный файл pytest
```

**Содержимое .coveragerc:**
```
[run]
branch = True

# Regexes для пропуска файлов и директорий
omit =
    */migrations/*
    */settings.py

[report]
# Падение при недостаточном покрытии
fail_under = 50
# Пропуск в отчете файлов со 100% покрытием
skip_covered = True
```

Также ранее упоминал, что тесты могут быть сконфигурированы при помощи pyproject.toml, покрытие тоже можно размещать там же, что унифицирует подход и аггрегирует настройки в одном месте! 

```toml
[tool.pytest.ini_options]
addopts = "-v --cov=src --cov-config=.coveragerc"
python_files = "test*.py"
testpaths = "src"

[tool.coverage.run]
branch = true
omit = [
    "*/__init__.py",
    "*/migrations/*",
    "*/settings.py",
]

[tool.coverage.report]
fail_under = 50
skip_covered = true
```

```ini
[pytest]
;Где искать тесты
testpaths = tests
;Шаблон для поиска тестов
python_files = "test_*.py"
; Дополнительные опции (-v — подробный вывод)
addopts = -v --cov=src --cov-config=.coveragerc --cov-report=term-missing
```

Расширим `pytest.ini` флагом `--cov-report=term-missing` и выполним команду `pytest`.  
**Ожидаемый результат:**

![](https://ucarecdn.com/ae5a5c2c-8276-4ad2-af64-5f1a8de8979b/)

Где:

- **Missing** — номера непокрытых строк (например, строки 44-45, 51-52, 5н, 64, 110-125 в файле `src/main.py` не выполнились при тестах).
    
**term-missing** относится к функциональности плагина pytest-cov (для измерения покрытия кода тестами), которая **специально подсвечивает строки кода, не выполненные во время тестов**.

Эта командная строка для `pytest` (при установленном `pytest-cov`) указывает плагину сформировать **подробный отчёт прямо в терминале**, включая:
- какие строки кода были пропущены тестами (`Missing`);    
- общий процент покрытия;
- разбивку по файлам.