Попробуем вот такой пример:
```postgresql
drop table if exists entity;

create table entity (
    entity_id bigint generated always as identity primary key,
    name varchar(50)
);

insert into entity(name)
select substring(md5(random()::text) || md5(random()::text)
                 from 1 for (floor(random() * 46)::int + 5))
from generate_series(1, 10000000);

create index idx_entity_name on entity(name);
```

Сделаем explain analyze запроса с высокой селективностью
```postgresql
explain analyze select * from entity where name='abacaba';
___________________
Index Scan using idx_entity_name on entity  (cost=0.56..8.58 rows=1 width=36) (actual time=0.034..0.034 rows=0 loops=1)
  Index Cond: ((name)::text = 'abacaba'::text)
Planning Time: 0.134 ms
Execution Time: 0.043 ms
```

Как видим индекс используется и всё круто. А если сделать его так?
```postgresql
explain analyze select * from entity where lower(name)='abcdefbzz';
___________________________
Gather  (cost=1000.00..152043.90 rows=50001 width=36) (actual time=857.322..861.897 rows=0 loops=1)
  Workers Planned: 2
  Workers Launched: 2
  ->  Parallel Seq Scan on entity  (cost=0.00..146043.80 rows=20834 width=36) (actual time=847.772..847.773 rows=0 loops=3)
        Filter: (lower((name)::text) = 'abcdefbzz'::text)
        Rows Removed by Filter: 3333333
Planning Time: 0.054 ms
JIT:
  Functions: 6
  Options: Inlining false, Optimization false, Expressions true, Deforming true
  Timing: Generation 0.623 ms, Inlining 0.000 ms, Optimization 0.384 ms, Emission 5.549 ms, Total 6.557 ms
Execution Time: 862.127 ms
```

Видим уже совсем другую картину. Индекс не используется. Почему так? В индексе хранятся ключи которые соответствуют значению колонки name, а не значению функции lower взятой от name.

Что делать в таком случае? Надо просто создать индекс по выражению и тогда он будет использоваться
```postgresql
create index idx_entity_name on entity(lower(name));
explain analyze select * from entity where lower(name)='abcdefbzz';
______________
Bitmap Heap Scan on entity  (cost=1604.06..77931.48 rows=50000 width=36) (actual time=0.028..0.029 rows=0 loops=1)
  Recheck Cond: (lower((name)::text) = 'abcdefbzz'::text)
  ->  Bitmap Index Scan on idx_entity_name  (cost=0.00..1591.56 rows=50000 width=0) (actual time=0.026..0.026 rows=0 loops=1)
        Index Cond: (lower((name)::text) = 'abcdefbzz'::text)
Planning Time: 0.147 ms
Execution Time: 0.045 ms
```

При этом просто по name такой индекс работать не будет.