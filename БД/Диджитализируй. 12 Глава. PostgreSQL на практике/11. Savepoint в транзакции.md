
Внутри транзакции можно сохраниться (поставить точку сохранения).
К сохранённым точкам можно возвращаться внутри транзакции. 

Пример

Допустим мы загружаем пакетно пункты выдачи заказов какой-то службы доставки.

![[Pasted image 20250901195713.png]]

И мы хотим сделать так, чтобы те пвз, которые проходят все условия были сохранены, а те что не прошли, соответсвено нет.

Допустим у нас есть две таблицы для хранения этих данных
```postgresql
drop table if exists pvz, pvz_tariff cascade;

create table pvz (
    pvz_id serial primary key,
    address varchar(2000) not null,
    latitude numeric(8,6) not null check (latitude between -90 and 90),
    longitude numeric(9,6) not null check (longitude between -180 and 180)
);

create table pvz_tariff (
    pvz_tariff_id serial primary key,
    pvz_id bigint references pvz(pvz_id) not null,
    delivery_price int not null check (delivery_price > 0)
);
```


Начинаем транзакцию, вставляем первый пвз и создаём первую точку сохранения при помощи **savepoint**
```postgresql
begin;

savepoint point0;

insert into pvz (address, latitude, longitude)
values ('г. Москва, ул. Арбат, 12', 55.752220, 37.615560)
returning pvz_id;

insert into pvz_tariff (pvz_id, delivery_price)
values (1, 225);
```

Создаём новую точку сохранения и вставляем второй пвз
```postgresql
savepoint point1;

insert into pvz (address, latitude, longitude)
values ('г. Москва, проспект Мира, 25', 55.760000, 37.630000)
returning pvz_id;

insert into pvz_tariff (pvz_id, delivery_price)
values (2, 320);
```

Делаем ещё одну точку сохранения, только  теперь в процессе вставки возникает ошибка
```postgresql
savepoint point2;

insert into pvz (address, latitude, longitude)
values ('г. Москва, ул. Тверская, 7', 92.10000, 37.620000)
returning pvz_id;
-- падает ошибка
-- делаем rollback 
```

И мы можем вернуться к последней точке сохранения point2
```postgresql
rollback to point2;
```

**Чтобы откатиться до точки сохранения используется rollback to <название точки>**
Так можно делать многократно

И теперь достаточно сделать commit для применения изменений (первые 2 пвз вставились без проблем)

```postgresql
commit;
```